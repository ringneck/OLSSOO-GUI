<!--
 * Asterisk-GUI	- an Asterisk configuration interface
 *
 * Manage Paging/Intercom
 *
 * Copyright (C) 2008, Digium, Inc.
 *
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="js/jquery.js"></script>
<script src="js/astman.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<style type="text/css">

	#table_pgoups_list {
		border: 0px solid #666666;
		margin-top: 8px;
		padding : 1px;
		width: 96%;
	}

	#table_pgoups_list {
		border: 1px solid #666666;
		margin-top: 5px;
		margin-bottom:10px;
		width: 96%;
		text-align: center;
		padding : 1px;
	}
	#table_pgoups_list tr.frow { background: #6b79a5; color: #CED7EF; }
	#table_pgoups_list tr.frow td{ font-weight:bold; }
	#table_pgoups_list tr td{ padding : 3px; }
	#table_pgoups_list tr.even { background: #DFDFDF; }
	#table_pgoups_list tr.odd{ background: #FFFFFF; }
	#table_pgoups_list tr.even:hover, #table_pgoups_list tr.odd:hover {
		background: #a8b6e5;
		cursor: default;
	}

</style>
<script>
/*

	[pagegroups]									// ASTGUI.contexts.PageGroups
	exten => 6051,1,Macro(pagingintercom|SIP/6000&SIP/6005&SIP/6007|qd)


*/


var isNewPgGrp;
var PgGrp_EDITING; // page group being edited
var listOfDialDevices = [];
var loadDOMelements = function(){
	DOM_pagegroup_editdiv = _$('pagegroup_editdiv');
	DOM_table_pageGroups_list = _$('table_pageGroups_list');



	DOM_text_pageGroup_Exten = _$('text_pgExten');
	DOM_select_pageGroup_Type = _$('select_pg_type');
	DOM_chk_pageGroup_beep = _$('chk_pgrp_beep');

	DOM_select_ringthesechannels = _$('select_ringthesechannels');
	DOM_select_fromlistofchannels = _$('select_fromlistofchannels');
		DOM_button_addall_toringlist = _$('button_addall_toringlist');
		DOM_button_add_toringlist = _$('button_add_toringlist');
		DOM_button_remove_fromringlist = _$('button_remove_fromringlist');
		DOM_button_removeall_fromringlist = _$('button_removeall_fromringlist');


};

var save_pageGroup = function(){
	if ( !ASTGUI.checkRequiredFields([DOM_text_pageGroup_Exten, DOM_select_pageGroup_Type]) ){
		return ;
	}
	if ( !ASTGUI.validateFields([DOM_text_pageGroup_Exten]) ){
		return ;
	}

	var TEMP_members = ASTGUI.selectbox.readAllValues(DOM_select_ringthesechannels) ;
	if( !TEMP_members.length ){
		ASTGUI.highlightField(DOM_select_ringthesechannels, 'You need to have at least one member in the Page/Intercom group !!');
		parent.ASTGUI.dialog.hide();
		return;
	}

	var PAGE_EXTEN = ASTGUI.getFieldValue( DOM_text_pageGroup_Exten );
	if( !isNewPgGrp ){ // if editing existing ring group
		parent.astgui_manageRingGroups.deleteRg(PgGrp_EDITING) ;
	}else{ // if is a new ring group
		if( parent.miscFunctions.ifExtensionAlreadyExists(PAGE_EXTEN) ){
			ASTGUI.highlightField(DOM_text_pageGroup_Exten , 'Extension already exists');
			parent.ASTGUI.dialog.hide();
			return;
		}

		// if( !ASTGUI.miscFunctions.isExtensionInRange( PAGE_EXTEN , 'rge_start' , 'rge_end' ) ){
		//	ASTGUI.highlightField(DOM_text_pageGroup_Exten, 'Extension is not in preferred range');
		//	parent.ASTGUI.dialog.hide();
		//	return;
		// }
	}

	var tmp_options = [];
	if ( ASTGUI.getFieldValue(DOM_select_pageGroup_Type) == '2way' ){ tmp_options.push('d'); }
	if ( !DOM_chk_pageGroup_beep.checked ){ tmp_options.push('q'); }

	var tmp_new_line = PAGE_EXTEN + ',1,Macro(pagingintercom|' + TEMP_members.join('&') + '|'+ tmp_options.join('') + ')' ;

	var later = function(){
		var msg = ( isNewPgGrp ) ? 'New Page/Intercom Group Created' : 'Page/Intercom Group Updated';
		ASTGUI.feedback({msg: msg, showfor:2});
		parent.ASTGUI.dialog.hide();
		window.location.reload();
	};

	parent.ASTGUI.dialog.waitWhile(' Saving... ');
	parent.astgui_managePageGroups.addPageGroup( tmp_new_line, later );
};


var resetFields = function(){
	if(isNewPgGrp){
		_$('pagegroup_editdiv_title').innerHTML = 'New Page/Intercom Group';

		ASTGUI.resetTheseFields([ DOM_text_pageGroup_Exten , DOM_select_pageGroup_Type , DOM_chk_pageGroup_beep ]);
		ASTGUI.selectbox.clear( DOM_select_ringthesechannels );
		ASTGUI.selectbox.clear( DOM_select_fromlistofchannels );
		listOfDialDevices.each(function(device){ 
			var tmp_ext = device.afterChar('/');
			var tmp_techn = device.beforeChar('/');

			if( tmp_techn.toLowerCase() == 'zap' ){

				var this_analogStation_user = '';
				for ( var q in parent.sessionData.pbxinfo.users ){ if( parent.sessionData.pbxinfo.users.hasOwnProperty(q) ){
					if( parent.sessionData.pbxinfo.users[q].getProperty('zapchan') == tmp_ext ){
						this_analogStation_user = q + '(AnalogPort ' + tmp_ext + ') ' + parent.sessionData.pbxinfo.users[q].getProperty('fullname') ;
						ASTGUI.selectbox.append( DOM_select_fromlistofchannels, this_analogStation_user , device);
						return;
					}
				}}

			}else{

				if( parent.sessionData.pbxinfo.users[tmp_ext] && parent.sessionData.pbxinfo.users[tmp_ext].fullname ){
					var tmp_name = parent.sessionData.pbxinfo.users[tmp_ext].fullname || '?' ;
				}else{
					return;
				}
				ASTGUI.selectbox.append( DOM_select_fromlistofchannels, tmp_ext + '('+ tmp_techn +')' + ' ' + tmp_name , device);
			}
		});

		(function(){
			var tmp_aliasextens = [];
			var rgs_list = parent.sessionData.pbxinfo.ringgroups.getOwnProperties();
			rgs_list.each( function(rg){
				var c = parent.sessionData.pbxinfo['ringgroups'][rg];
				if( c['extension'] ){
					tmp_aliasextens.push( c['extension'] );
				}
			});
			tmp_aliasextens = tmp_aliasextens.concat( astgui_managePageGroups.getPGsList() );
			DOM_text_pageGroup_Exten.value  = tmp_aliasextens.firstAvailable( parent.sessionData.GUI_PREFERENCES.getProperty('rge_start') );
		})();

		return ;
	}

	var c = parent.sessionData.pbxinfo['pagegroups'] ;
	_$('pagegroup_editdiv_title').innerHTML = 'Edit Page/Intercom Group - ' + PgGrp_EDITING ;

	var line = '';
	try{
		line = c[  c.indexOfLike('exten='+PgGrp_EDITING+',1,Macro(pagingintercom')  ] ;
	}catch(err){}

	if(!line) return;
	var tmp_args = ASTGUI.parseContextLine.getArgs( line );
	var tmp_members = tmp_args[1].split('&');

	ASTGUI.updateFieldToValue( DOM_text_pageGroup_Exten, PgGrp_EDITING );
	ASTGUI.updateFieldToValue( DOM_select_pageGroup_Type, tmp_args[2].contains('d') ? '2way' : '1way' );
	DOM_chk_pageGroup_beep.checked = !tmp_args[2].contains('q');

	ASTGUI.selectbox.clear( DOM_select_ringthesechannels );
	var mbrs = ASTGUI.cloneObject(tmp_members) ; 
	mbrs.each(function(device){
		var tmp_ext = device.afterChar('/');
		var tmp_techn = device.beforeChar('/');

		if( tmp_techn.toLowerCase() == 'zap' ){
			var this_analogStation_user = '';
			for( var q in parent.sessionData.pbxinfo.users ){ if( parent.sessionData.pbxinfo.users.hasOwnProperty(q) ){
				if( parent.sessionData.pbxinfo.users[q].getProperty('zapchan') == tmp_ext ){
					this_analogStation_user = q + '(AnalogPort ' + tmp_ext + ') ' + parent.sessionData.pbxinfo.users[q].getProperty('fullname') ;
					ASTGUI.selectbox.append( DOM_select_ringthesechannels, this_analogStation_user , device );
					return;
				}
			}}
		}else{
			var tmp_name = (parent.sessionData.pbxinfo.users[tmp_ext] && parent.sessionData.pbxinfo.users[tmp_ext].fullname) || '?';
			ASTGUI.selectbox.append( DOM_select_ringthesechannels, tmp_ext + '('+ tmp_techn +')' + ' ' + tmp_name , device);
		}
	});


	ASTGUI.selectbox.clear( DOM_select_fromlistofchannels );
	listOfDialDevices.each(function(device){ if( ! mbrs.contains(device) ){
		var tmp_ext = device.afterChar('/');
		var tmp_techn = device.beforeChar('/');

		if( tmp_techn.toLowerCase() == 'zap' ){
			var this_analogStation_user = '';
			for( var q in parent.sessionData.pbxinfo.users ){ if( parent.sessionData.pbxinfo.users.hasOwnProperty(q) ){
				if( parent.sessionData.pbxinfo.users[q].getProperty('zapchan') == tmp_ext ){
					this_analogStation_user = q + '(AnalogPort ' + tmp_ext + ') ' + parent.sessionData.pbxinfo.users[q].getProperty('fullname') ;
					ASTGUI.selectbox.append( DOM_select_fromlistofchannels, this_analogStation_user , device );
					return;
				}
			}}
		}else{
			var tmp_name = (parent.sessionData.pbxinfo.users[tmp_ext] && parent.sessionData.pbxinfo.users[tmp_ext].fullname)  || '?' ;
			ASTGUI.selectbox.append( DOM_select_fromlistofchannels, tmp_ext + '('+ tmp_techn +')' + ' ' + tmp_name , device);
		}
	}});
};


var delete_pageGroup_confirm = function(d){
	if (!confirm('Delete Page/Intercom Group ?')) { return; }
	parent.astgui_managePageGroups.deletePageGroup(d, function(){
		ASTGUI.feedback({ msg:'Page/Intercom Group deleted', showfor:2 });
		window.location.reload();
	});
};

var show_NewPageGroup_form = function(){
	PgGrp_EDITING = '';
	isNewPgGrp = true;
	resetFields();
	ASTGUI.feedback({ msg: 'Create New Page/Intercom Extension !', showfor: 2 , color: 'green', bgcolor: '#FFFFFF' });
	$(DOM_pagegroup_editdiv).showWithBg();
};


var edit_pageGroup_form = function(d){
	PgGrp_EDITING = d;
	isNewPgGrp = false;
	resetFields();
	ASTGUI.feedback( { msg: 'Edit Page/Intercom Extension !', showfor: 2 , color: 'green', bgcolor: '#FFFFFF' } );
	$(DOM_pagegroup_editdiv).showWithBg();
};


var update_PageGroupsTable = function(){
	var addCell = ASTGUI.domActions.tr_addCell; // temporarily store the function
	(function(){ // add first row
		var newRow = DOM_table_pageGroups_list.insertRow(-1);
		newRow.className = "frow";
		addCell( newRow , { html:'', width:'10px'} );
		addCell( newRow , { html: 'Extension' });
		addCell( newRow , { html: 'Type' });
		addCell( newRow , { html:'Members'});
		addCell( newRow , { html:''} );
	})();

	var c = parent.sessionData.pbxinfo['pagegroups'] ;
	c.each( function( line ){
		var this_exten = ASTGUI.parseContextLine.getExten(line);
		var tmp_args = ASTGUI.parseContextLine.getArgs( line );
		var tmp_members = tmp_args[1].split('&').join(', ');


		var newRow = DOM_table_pageGroups_list.insertRow(-1);
		var rn = DOM_table_pageGroups_list.rows.length;
		newRow.className = ((rn)%2==1)?'odd':'even';

		addCell( newRow , { html:'' } );
		addCell( newRow , { html: this_exten });
		addCell( newRow , { html: tmp_args[2].contains('d') ? 'Intercom' : 'Pager' });
		addCell( newRow , { html: tmp_members });
		var tmp = "<span class='guiButton' onclick=\"edit_pageGroup_form('" + this_exten +"')\">Edit</span>" +
				"<span class='guiButtonDelete' onclick=\"delete_pageGroup_confirm('" + this_exten +"')\">Delete</span>" ;
		addCell( newRow , { html: tmp } );
	});

	if(DOM_table_pageGroups_list.rows.length == 1){
		ASTGUI.domActions.clear_table(DOM_table_pageGroups_list);
		var newRow = DOM_table_pageGroups_list.insertRow(-1);
		newRow.className = 'even';
		addCell( newRow , { html:'No Page/Intercom Extensions defined !!'} );
		return ;
	}
};


var localajaxinit = function(){
	top.document.title = 'Paging & Intercom' ;
	if( !ASTGUI.miscFunctions.alertIfRangeisNotdefined('rge_start','rge_end', 'RingGroups') ){
		$('.top_buttons').hide();
		return;
	}

	loadDOMelements();
	
	(function (){
		var t = parent.astgui_manageusers.listOfUsers();
		t.each(function(usr){	
			if( parent.sessionData.pbxinfo['users'][usr]['hassip']  && parent.sessionData.pbxinfo['users'][usr]['hassip'] == 'yes' ){
				listOfDialDevices.push( 'SIP/' + usr );
			}
			if( parent.sessionData.pbxinfo['users'][usr]['hasiax']  && parent.sessionData.pbxinfo['users'][usr]['hasiax'] == 'yes' ){
				listOfDialDevices.push( 'IAX2/' + usr );
			}
		});
		t = parent.sessionData.FXS_PORTS_DETECTED ;
		t.each(function(fxs){
			listOfDialDevices.push('Zap/' + fxs );
		});

		ASTGUI.events.add( DOM_button_add_toringlist , 'click' , function(){
			var t = DOM_select_fromlistofchannels.value ; if(!t){return;}
			var s = DOM_select_fromlistofchannels.options[DOM_select_fromlistofchannels.selectedIndex].text ; if(!s){ s = t; }
			DOM_select_fromlistofchannels.remove( DOM_select_fromlistofchannels.selectedIndex );
			ASTGUI.selectbox.append( DOM_select_ringthesechannels, s , t );
		});
		ASTGUI.events.add( DOM_button_remove_fromringlist , 'click' , function(){
			var t = DOM_select_ringthesechannels.value ; if(!t){return;}
			var s = DOM_select_ringthesechannels.options[DOM_select_ringthesechannels.selectedIndex].text ; if(!s){ s = t; }
			DOM_select_ringthesechannels.remove( DOM_select_ringthesechannels.selectedIndex );
			if( listOfDialDevices.contains(t) ){ ASTGUI.selectbox.append( DOM_select_fromlistofchannels, s, t ); }
		});
		ASTGUI.events.add( DOM_button_removeall_fromringlist , 'click' , function(){
			ASTGUI.selectbox.clear( DOM_select_ringthesechannels );
			ASTGUI.selectbox.clear( DOM_select_fromlistofchannels );
			listOfDialDevices.each(function(device){ 
				var tmp_ext = device.afterChar('/');
				var tmp_techn = device.beforeChar('/');
	
				if( tmp_techn.toLowerCase() == 'zap' ){
					var this_analogStation_user = '';
					for ( var q in parent.sessionData.pbxinfo.users ){ if( parent.sessionData.pbxinfo.users.hasOwnProperty(q) ){
						if( parent.sessionData.pbxinfo.users[q].getProperty('zapchan') == tmp_ext ){
							this_analogStation_user = q + '(AnalogPort ' + tmp_ext + ') ' + parent.sessionData.pbxinfo.users[q].getProperty('fullname') ;
							ASTGUI.selectbox.append( DOM_select_fromlistofchannels, this_analogStation_user , device);
							return;
						}
					}}
				}else{
					if( parent.sessionData.pbxinfo.users[tmp_ext] && parent.sessionData.pbxinfo.users[tmp_ext].fullname ){
						var tmp_name = parent.sessionData.pbxinfo.users[tmp_ext].fullname || '?' ;
					}else{
						return;
					}
					ASTGUI.selectbox.append( DOM_select_fromlistofchannels, tmp_ext + '('+ tmp_techn +')' + ' ' + tmp_name , device);
				}
			});
		});

		ASTGUI.events.add( 'button_addall_toringlist' , 'click' , function(){
			ASTGUI.selectbox.clear( DOM_select_ringthesechannels );
			ASTGUI.selectbox.clear( DOM_select_fromlistofchannels );

			listOfDialDevices.each(function(device){ 
				var tmp_ext = device.afterChar('/');
				var tmp_techn = device.beforeChar('/');
	
				if( tmp_techn.toLowerCase() == 'zap' ){
					var this_analogStation_user = '';
					for ( var q in parent.sessionData.pbxinfo.users ){ if( parent.sessionData.pbxinfo.users.hasOwnProperty(q) ){
						if( parent.sessionData.pbxinfo.users[q].getProperty('zapchan') == tmp_ext ){
							this_analogStation_user = q + '(AnalogPort ' + tmp_ext + ') ' + parent.sessionData.pbxinfo.users[q].getProperty('fullname') ;
							ASTGUI.selectbox.append( DOM_select_ringthesechannels, this_analogStation_user , device);
							return;
						}
					}}
				}else{
					if( parent.sessionData.pbxinfo.users[tmp_ext] && parent.sessionData.pbxinfo.users[tmp_ext].fullname ){
						var tmp_name = parent.sessionData.pbxinfo.users[tmp_ext].fullname || '?' ;
					}else{
						return;
					}
					ASTGUI.selectbox.append( DOM_select_ringthesechannels, tmp_ext + '('+ tmp_techn +')' + ' ' + tmp_name , device);
				}
			});
		});

	})();

	update_PageGroupsTable();

};


</script>
<body bgcolor="EFEFEF">
<div class="iframeTitleBar"> 
	Paging & Intercom
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.reload();" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>

<div class='lite_Heading'> Page/Intercom Groups </div>

<div class='top_buttons'  style='margin-top: -22px;'>
	<span id='new' class='guiButtonNew' onclick='show_NewPageGroup_form();'>New Page/Intercom Group </span>
</div>

<table id='table_pageGroups_list' cellpadding=0 cellspacing=0 border=0 align=center></table>

<div id="pagegroup_editdiv" STYLE="width:600;display:none;" class='dialog'>
	<TABLE width="100%" cellpadding=0 cellspacing=0>
	<TR class="dialog_title_tr">
		<TD class="dialog_title" onmousedown="ASTGUI.startDrag(event);">
			<span id="pagegroup_editdiv_title"></span>
		</TD>
		<TD class="dialog_title_X" onclick="ASTGUI.hideDrag(event);"> X </TD>
	</TR>
	</TABLE>
	<table cellpadding=2 cellspacing=2 border=0 width="100%" align="center">
		<tr>	<td align=right valign=top>Extension for this Page/Intercom Group :</td>
			<td colspan=2><input type=text id="text_pgExten" size=5 field_name='Extension for Page/Intercom Group' validation='numeric' required='yes'></td>
		</tr>

		<TR>	<td align="right">Type :&nbsp;</td>
			<td colspan=2>
				<select id="select_pg_type" dfalt='2way' required='yes'>
				<option value="2way">2-Way Intercom</option>
				<option  value="1way">1-Way Page</option>
				</select>
			</td>
		</TR>

		<tr>	<td align=right>Play a beep :&nbsp;</td>
			<td colspan=2><input type=checkbox id="chk_pgrp_beep"></td>
		</tr>

		<tr>	<td align=center valign=top>
				<B>Page/Intercom Group Members</B>
			</td>
			<td width=50 align=center></td>
			<td align=left valign=top>
				<B>Available Users</B>
			</td>
		</tr>
		<tr>	<td align=right valign=top>
				<select id="select_ringthesechannels" style="width: 240px" size=8></select>
			</td>
			<td width=80 align=center valign=top>
				<span class='guiButton' id='button_addall_toringlist'>&#171;&#171;</span><BR><BR>
				<span class='guiButton' id='button_add_toringlist'>&#8592;</span><BR><BR>
				<span class='guiButton' id='button_remove_fromringlist'>&#8594;</span><BR><BR>
				<span class='guiButton' id='button_removeall_fromringlist'>&#187;&#187;</span>
			</td>
			<td align=left valign=top>
				<select id="select_fromlistofchannels" style="width: 240px" size=8></select>
			</td>
		</tr>
		<tr>	<td align="right" colspan=3 height=10></td></tr>
		<tr>	<td align=center colspan=3>
				<span class='guiButtonCancel' onclick='ASTGUI.hideDrag(event);'>Cancel</span>
				<span class='guiButtonEdit' onclick='save_pageGroup();'>Save</span>
			</td>
		</tr>
	</table>
</div>

</body>
