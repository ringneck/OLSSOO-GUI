<!--
 * Asterisk-GUI	- an Asterisk configuration interface
 *
 * Display key system information
 *
 * Copyright (C) 2006-2008, Digium, Inc.
 *
 * Pari Nannapaneni <pari@digium.com>
 * Brandon Kruse <bkruse@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
 -->
<script src="js/jquery.js"></script>
<script src="js/astman.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<style type="text/css">

</style>
<script>

var percentage_usage = function(du){
	var get_CF_percent = function(a){
		var du_lines = a.split('\n');
		var line;
		for( var t =0 ; t < du_lines.length ; t++ ){
			line = du_lines[t];
			if( ! line.beginsWith('/dev/hda1 ') ){ continue; }
	
			var before_p_str = line.beforeChar('%');
			var start_p = before_p_str.lastIndexOf(' ');
			return before_p_str.substring(start_p+1);
		}
		return 0;
	};
	var p = get_CF_percent(du);
	if( p == 0 ){return;}
	var width_1 = Math.floor( Number(p) * 1.5 ) ;
	var width_2 = 150 - width_1 ;
	var table_percent = "<table><tr><td valign=top>" 
			+ "<table width=150 border=0 cellpadding=0 cellspacing=0 bgcolor=#E6C79D>"
			+ "<tr><td width='" + width_1 + "' height=12 bgcolor='#6D4B1D'></td>"
			+ "<td width='" + width_2 + "'></td></tr></table>"
		+ "</td><td>&nbsp;" + p + "% used</td>"
		+ "</tr></table>";
	_$('CF_Usage_td').innerHTML = table_percent ;
	_$('CF_Usage').style.display = '';
};

function getsysinfohtml(){
	_$('sysinfohtml').innerHTML = ASTGUI.loadHTML(ASTGUI.paths.output_SysInfo);
	_$('osversion').innerHTML = _$('si_uname').innerHTML;
	_$('uptime').innerHTML = _$('si_uptime').innerHTML.replace(/load average/, "<BR>Load Average");
	_$('asterisk').innerHTML =  parent.sessionData.AsteriskVersionString + "<BR>" + "Asterisk GUI-version : " + ( parent.sessionData.gui_version || ASTGUI.globals.version ) ;
	_$('today').innerHTML = (parent.sessionData.PLATFORM.isAA50) ? ASTGUI.toLocalTime(_$('si_date').innerHTML).camelize() : _$('si_date').innerHTML ;
	if(parent.sessionData.PLATFORM.isAA50) {
		_$('today').innerHTML += "&nbsp;&nbsp;<A href='date.html' class='splbutton' title='Click to update Date and Time'><B>Edit</B></A>";
	}
	_$('hostname').innerHTML =_$('si_hostname').innerHTML;
	$('#tabbedMenu').find('A:eq(0)').click();
}

var localajaxinit = function(){
	top.document.title = 'System Information' ;
	parent.ASTGUI.dialog.waitWhile('Loading system Information ...');

	(function(){
		var t = [{	url:'#',
				desc:'General',
				click_function: function(){
					$('.hideall').hide();
					$('#osversion_div').show();
					$('#uptime_div').show();
					$('#asterisk_div').show();
					$('#today_div').show();
					$('#hostname_div').show();
				}
			},{	url: '#',
				desc: 'Network',
				click_function: function(){
					$('.hideall').hide();
					ASTGUI.systemCmdWithOutput( 'ifconfig' , function(output){
						_$('ifconfig').innerHTML = '<pre>' + output +'</pre>' ;
						$('.hideall').hide();
						$('#ifconfig_div').show();
					});
				}
			},{	url: '#',
				desc: 'Disk Usage',
				click_function: function(){
					$('.hideall').hide();
					ASTGUI.systemCmdWithOutput( 'df -k' , function(output){
						_$('diskusage').innerHTML = '<pre>' + output +'</pre>';
						if(parent.sessionData.PLATFORM.isAA50) {
							try{
								percentage_usage(output);
							}catch(err){
								ASTGUI.Log.Debug( '<B>Error Trying to calculate CF usage %');
							}
						}
						$('.hideall').hide();
						$('#df_div').show();
					});
				}
			},{	url: '#',
				desc: 'Memory Usage',
				click_function: function(){
					$('.hideall').hide();
					ASTGUI.systemCmdWithOutput( 'free' , function(free){
						_$('memoryusage').innerHTML = '<pre>' + free +'</pre>';
						$('.hideall').hide();
						$('#memory_div').show();
					});
				}
			}];
		if( parent.sessionData.PLATFORM.isAA50 ) {
			t.push({	url:'#',
					desc:'S800i Config',
					click_function: function(){
						$('.hideall').hide();
						ASTGUI.systemCmdWithOutput( 's800iconfig' , function(output){
							_$('s800i_config').innerHTML = '<PRE>' + output.replace(/S800i Product Configuration/, '') + '</PRE>';
							$('.hideall').hide();
							$('#s800i_div').show();
						});
					}
				});
		}
		ASTGUI.tabbedOptions( _$('tabbedMenu') , t );
	})();
	parent.ASTGUI.systemCmd( parent.ASTGUI.scripts.SysInfo, function(){ parent.ASTGUI.dialog.hide(); getsysinfohtml(); } );
}


</script>
<body bgcolor="EFEFEF">
<div id="sysinfohtml" style="display:none"></div>

<div class="iframeTitleBar"> System Information <span style="cursor: pointer; cursor: hand;" onclick="window.location.reload();" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span> </div>

<div id="tabbedMenu"></div>

<div id="information" style="margin-left: 20px; margin-top: 10px; width: 95%">
	<div id="osversion_div" style="display:none" class='hideall'>
		<B>OS Version:</B> <div id="osversion" style="font-family:courier; font-size:10pt;"></div><BR>
	</div>
	<div id="uptime_div" style="display:none" class='hideall'>
		<B>Uptime:</B> <div id="uptime" style="font-family:courier; font-size:10pt;"></div><BR>
	</div>
	<div id="asterisk_div" style="display:none" class='hideall'>
		<B>Asterisk Build:</B> <div id="asterisk" style="font-family:courier; font-size:10pt;"></div><BR>
	</div>
	<div id="today_div" style="display:none" class='hideall'>
		<B>Server Date & TimeZone:</B><span id="today" style="font-family:courier; font-size:10pt; padding:0px 0px 5px 5px;"></span><BR><BR>
	</div>
	<div id="hostname_div" style="display:none" class='hideall'>
		<B>Hostname:</B> <div id="hostname" style="font-family:courier; font-size:10pt;"></div><BR>
	</div>
	<div id="ifconfig_div" style="display:none;" class='hideall'>
		<div id="ifconfig" style="font-family:courier; font-size:9pt;overflow :auto;"></div>
	</div>
	<div id="df_div" style="display:none;" class='hideall'>
		<B>Disk Usage:</B><div id="diskusage" style="font-family:courier; font-size:10pt;"></div>
		<div id="CF_Usage" style="display:none; width: 430px">
			<table border=0>
				<tr>	<td><b><nobr>CompactFlash&reg; : </b></nobr></td>
					<td id="CF_Usage_td" width="300"></td>
				</tr>
			</table>
		</div>
	</div>
	<div id="memory_div" style="display:none;" class='hideall'>
		<B>Memory Usage:</B><div id="memoryusage" style="font-family:courier; font-size:9.5pt;"></div>
	</div>
	<div id="s800i_div" style="display:none;" class='hideall'>
		<table>
			<tr>	<td colspan=2 height=30 valign=middle align=center><B>s800i Product Configuration</B></td>
			</tr>
			<tr>	<td valign=middle width=210 align=center>
					<img src='images/aa50.png' border=0 width=165 height=88>
				</td>
				<td id="s800i_config" style="font-family:courier; font-size:8.5pt;">
				</td>
			</tr>
		</table>
	</div>
</div>

</body>
