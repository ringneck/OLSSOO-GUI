<!--
 * Asterisk-GUI	- an Asterisk configuration interface
 *
 * Follow Me
 *
 * Copyright (C) 2008, Digium, Inc.
 *
 * Pari Nannapaneni <pari@digium.com>
 * Malcolm Davenport <malcolmd@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="js/jquery.js"></script>
<script src="js/astman.js"></script>
<script src="js/jquery.tooltip.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<style type="text/css">
	#table_userslist {
		border: 1px solid #666666;
		margin-top: 5px;
		margin-bottom:10px;
		width: 96%;
		text-align: center;
		padding : 1px;
	}
	#table_userslist tr.frow { background: #6b79a5; color: #CED7EF; }
	#table_userslist tr.frow td{ font-weight:bold; }
	#table_userslist tr td{ padding : 3px; }
	#table_userslist tr.even { background: #DFDFDF; }
	#table_userslist tr.odd{ background: #FFFFFF; }
	#table_userslist tr.even:hover, #table_userslist tr.odd:hover {
		background: #a8b6e5;
		cursor: default;
	}


	#sqDestinations{
		height:120px ;
		background-color:#FFFFFF;
		padding: 5px;
		border-width: 1px;
		border-color: #7E5538;
		border-style: solid;
		cursor: default;
		font: 83%/1.4 arial, helvetica, sans-serif;
		overflow :auto;
	}
	
	#sqDestinations div {
		clear :both;
		padding : 3px 5px 0px 5px;
		min-height: 20px;
	}
	#sqDestinations div:hover {
		background-color:#DEDEDE;
	}
	
	#sqDestinations div span.step_desc {
		float: left;
		/* max-width: 300px; */
		background: transparent;
	}
	#sqDestinations div span.step_desc:hover{
		background-color:#DEDEDE;
	}
	
	#sqDestinations div span.step_up {
		float: right;
		width: 20px;
		background: transparent url("./images/asterisk-arrow-up.png") no-repeat;
	}
	
	#sqDestinations div span.step_down {
		float: right;
		width: 20px;
		background: transparent url("./images/asterisk-arrow-down.png") no-repeat;
	}
	
	#sqDestinations div span.step_delete {
		float: right;
		width: 20px;
		background: transparent url("./images/delete_circle.png") no-repeat;
	}

</style>
<script>
var EDIT_USER ;
var CURRENT_DESTINATIONS = [] ;

var load_users_table = function(){
	var TBL = _$('table_userslist') ;
	var addCell = ASTGUI.domActions.tr_addCell;
	var ul = parent.astgui_manageusers.listOfUsers();  ul = ul.sortNumbers( );

	if(!ul.length){
		ASTGUI.domActions.clear_table(TBL);
		var newRow = TBL.insertRow(-1);
		newRow.className = 'even';
		addCell( newRow , { html:'No users created !!'} );
		return ;
	}

	(function(){ // add first row
		var newRow = TBL.insertRow(-1);
		newRow.className = "frow";
		addCell( newRow , { html:'Extension'});
		addCell( newRow , { html:'Follow Me'});
		addCell( newRow , { html:'Follow Order'});

		addCell( newRow , { html:''});
	})();

	var ext_globals = context2json({filename: 'extensions.conf', context: 'globals' , usf: 1});
	var followme_cnf = config2json({filename: 'followme.conf', usf: 0});

	ul.each( function(user){ // list each user in table
		var fmvar = 'FOLLOWME_' + user ;

		var newRow = TBL.insertRow(-1); 
		newRow.className = ((TBL.rows.length)%2==1)?'odd':'even';
		addCell( newRow , { html: user });
		if ( ext_globals.hasOwnProperty(fmvar) &&  ext_globals[fmvar] == '1' ){
			addCell( newRow , { html: '<font color=green><b>Enabled</b></font>' });
			var tmp_a = "<span class='guiButton' onclick=\"show_Edit_FollowMeUser('" + user +"', 1)\">Edit</span>&nbsp;" ;
		}else{
			addCell( newRow , { html: '<font color=red><b>Disabled<b></font>' });
			var tmp_a = "<span class='guiButton' onclick=\"show_Edit_FollowMeUser('" + user +"', 0)\">Edit</span>&nbsp;" ;
		}
		if( followme_cnf.hasOwnProperty(user) &&  followme_cnf[user].containsLike('number=') ){
			var tmp_followorder = [];
			followme_cnf[user].each( function(line){
				if (line.beginsWith('number=') ){
					line = line.lChop('number=') ;
					// var fl_number = line.split(',')[0] ;
					// var fl_seconds = line.split(',')[1];
					tmp_followorder.push( line.split(',')[0] );
				}
			});
			tmp_followorder = tmp_followorder.join(', ');
			addCell( newRow , { html: (tmp_followorder.length > 50) ? tmp_followorder.substr(0,50) + '....' : tmp_followorder , align :'left' });
		}else{
			addCell( newRow , { html: '<i>Not Configured</i>' });
		}
		addCell( newRow , { html: tmp_a , align:'center' });
	} );
};


var localajaxinit = function(){
	top.document.title = 'Follow Me' ;
	load_users_table();

	(function(){
		var mcls = config2json({filename: 'musiconhold.conf', usf: 1});
		for (var this_class in mcls ){
			if(mcls.hasOwnProperty(this_class)){
				ASTGUI.selectbox.append('FMU_moh', this_class, this_class );
			}
		}
		_$('FMU_moh').selectedIndex = -1;

		var c = parent.astgui_manageCallPlans.listPlans() ;
		var tmp_pfx = ASTGUI.contexts.CallingPlanPrefix ;
		for( var c_t = 0 ; c_t < c.length ; c_t++ ){
			ASTGUI.selectbox.append( 'FMU_context' , c[c_t].withOut(tmp_pfx) , c[c_t] );
		}
	})();

	$('#sqDestinations').click(function(event){

		var s = ASTGUI.events.getTarget(event);
		var cl =  $(s).attr("class") ;
		if(!cl || !cl.beginsWith('step_') ){return;}
		var stepNo = Number( s.parentNode.STEPNO );
		switch(cl){
			case 'step_delete':
				CURRENT_DESTINATIONS.splice(stepNo,1);
				break;
			case 'step_up':
				if(stepNo == 0) return;
				var tmp = CURRENT_DESTINATIONS[stepNo] ;
				CURRENT_DESTINATIONS.splice(stepNo, 1);
				CURRENT_DESTINATIONS.splice(stepNo-1, 0, tmp);
				break;
			case 'step_down':
				if(stepNo == (CURRENT_DESTINATIONS.length-1) ) return;
				var tmp = CURRENT_DESTINATIONS[stepNo] ;
				CURRENT_DESTINATIONS.splice(stepNo+2, 0, tmp);
				CURRENT_DESTINATIONS.splice(stepNo, 1);
				break;
			default:
				break;
		}

		followMe_MiscFunctions.refresh_allDestinations();

	});
};



var show_Edit_FollowMeUser = function(u, fm_ed){

	EDIT_USER = u ;
	followMe_MiscFunctions.reset_Fields();

	// load fields
	if( !fm_ed ){
		fm_ed = 0;
	}else{
		fm_ed = Number(fm_ed);
	}

	if( fm_ed ){
		_$('FMU_Enable').checked = true ;
		_$('FMU_Disable').checked = false ;
	}else{
		_$('FMU_Enable').checked = false ;
		_$('FMU_Disable').checked = true ;
	}

	CURRENT_DESTINATIONS = [];

	var cxt = context2json({ filename:'followme.conf' , context : EDIT_USER , usf: 0 });
	if(!cxt){ cxt = []; }
	for( var t =0; t < cxt.length ; t++ ){

		if( cxt[t].beginsWith('musicclass=') ){
			ASTGUI.updateFieldToValue('FMU_moh', cxt[t].afterChar('=') );
		}

		if( cxt[t].beginsWith('context=') ){
			ASTGUI.updateFieldToValue('FMU_context', cxt[t].afterChar('=') );
		}

		if( cxt[t].beginsWith('number=') ){
			CURRENT_DESTINATIONS.push( cxt[t].afterChar('=') );
		}
	}

	followMe_MiscFunctions.refresh_allDestinations();
	$('#div_followUser_edit').showWithBg();
};





var save_FollowMeUser = function(){
 // we do not have seperate edit/new cases here, we just have to save the chosen preferences

	// update follow me status of the user in extensions.conf
	// update followme.conf with all other chosen preferences
	// reload the page

	var fm_enabled = ( _$('FMU_Enable').checked ) ? '1' : '0' ;
	ASTGUI.updateaValue({ file:'extensions.conf', context :'globals', variable : 'FOLLOWME_' + EDIT_USER , value : fm_enabled });

	var FOLLOWME_CONF = config2json({ filename:'followme.conf', usf:0 });

	var u = new listOfActions('followme.conf');
	if( FOLLOWME_CONF.hasOwnProperty(EDIT_USER) ){ u.new_action('delcat', EDIT_USER , '', ''); }
	u.new_action( 'newcat', EDIT_USER , '', '');
	u.new_action( 'append', EDIT_USER , 'musicclass', ASTGUI.getFieldValue('FMU_moh') );
	u.new_action( 'append', EDIT_USER , 'context', ASTGUI.getFieldValue('FMU_context') );
	for( var t=0; t < CURRENT_DESTINATIONS.length ; t++ ){
		u.new_action( 'append', EDIT_USER , 'number', CURRENT_DESTINATIONS[t] );
	}
	u.callActions( function(){
		window.location.reload();
	});

};


var followMe_MiscFunctions = {

	reset_Fields : function(){ // followMe_MiscFunctions.reset_Fields()
		ASTGUI.resetTheseFields ([ 'FMU_Enable', 'FMU_Disable', 'FMU_moh', 'FMU_context','FMU_newNumber','FMU_newNumber_seconds' ]);
		ASTGUI.domActions.removeAllChilds( 'sqDestinations' ); CURRENT_DESTINATIONS = [] ;

	},

	refresh_allDestinations: function(){ // followMe_MiscFunctions.refresh_allDestinations()
		ASTGUI.domActions.removeAllChilds( 'sqDestinations' );
		var add_sqStep = function(a){
			var txt = CURRENT_DESTINATIONS[a];
			var tmp = document.createElement('div');
			tmp.STEPNO = a ;
			var sp_desc = document.createElement('span');
				sp_desc.className = 'step_desc';
				sp_desc.innerHTML = txt.split(',')[0] + ' (' +  txt.split(',')[1] + ' seconds)' ;
			var sp_up = document.createElement('span');
				sp_up.className = 'step_up';
				sp_up.innerHTML = '&nbsp;';
			var sp_down = document.createElement('span');
				sp_down.className = 'step_down';
				sp_down.innerHTML = '&nbsp;';
			var sp_delete = document.createElement('span');
				sp_delete.className = 'step_delete';
				sp_delete.innerHTML = '&nbsp;';
	
			tmp.appendChild(sp_desc) ;
			tmp.appendChild(sp_delete) ;
			tmp.appendChild(sp_up) ;
			tmp.appendChild(sp_down) ;
			_$('sqDestinations').appendChild(tmp) ;
		};
		for( var t=0; t < CURRENT_DESTINATIONS.length ; t++ ){
			add_sqStep(t);
		}
	},

	push_newdest: function(){ // followMe_MiscFunctions.push_newdest() ;
		var t = ASTGUI.getFieldValue('FMU_newNumber') + ',' + ASTGUI.getFieldValue( 'FMU_newNumber_seconds' );

		CURRENT_DESTINATIONS.push(t);
		this.refresh_allDestinations();
		ASTGUI.resetTheseFields (['FMU_newNumber','FMU_newNumber_seconds' ]);
	}

};


</script>
<body bgcolor="EFEFEF">
	<div class="iframeTitleBar"> 
		Follow Me <span class='refresh_icon' onclick="window.location.reload();" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
	</div>

	<div class='lite_Heading' id='thisPage_lite_Heading'>'<i>Follow Me</i>' preferences for users</div>
	
	<table id='table_userslist' cellpadding=0 cellspacing=0 border=0 align=center style='clear:both;'></table>


<div id="div_followUser_edit" STYLE="width:550; display:none;" class='dialog'>
	<TABLE width="100%" cellpadding=0 cellspacing=0>
	<TR class="dialog_title_tr">
		<TD class="dialog_title" onmousedown="ASTGUI.startDrag(event);">
			<span id="div_followUser_edit_title"></span></TD>
		<TD class="dialog_title_X" onclick="ASTGUI.hideDrag(event);"> X </TD>
	</TR>
	</TABLE>
	
	<TABLE	align=center cellpadding=2 cellspacing=2 border=0 width='100%'>
		<tr>	<td align=right width=200>Status <img src="images/tooltip_info.gif" tip="en,followme,0" class='tooltipinfo'> :</td>
			<td>	<input type=radio id='FMU_Enable' name='radio_FMU_EnableDisable'> <font color=green><b>Enable</b></font> <input type=radio id='FMU_Disable' name='radio_FMU_EnableDisable'> <font color=red><b>Disable</b></font> </td>
		</tr>
		<tr>	<td align=right width=200>'Music On Hold' Class <img src="images/tooltip_info.gif" tip="en,followme,1" class='tooltipinfo'> :</td>
			<td>	<select id='FMU_moh' required='yes'> </td>
		</tr>
		<tr>	<td align=right>DialPlan <img src="images/tooltip_info.gif" tip="en,followme,2" class='tooltipinfo'> :</td>
			<td>	<select id='FMU_context' required='yes'> </td>
		</tr>
		<tr>	<td align=right valign=top>Destinations <img src="images/tooltip_info.gif" tip="en,followme,3" class='tooltipinfo'> :</td>
			<td>	<div id='sqDestinations'></div>	</td>
		</tr>

		<tr>	<td align=right>Add FollowMe Number <img src="images/tooltip_info.gif" tip="en,followme,4" class='tooltipinfo'> :</td>
			<td>&nbsp;try <input id='FMU_newNumber' size=10> for <input id='FMU_newNumber_seconds' size=1> Seconds <span class='guiButton' onclick="followMe_MiscFunctions.push_newdest();"> &uarr; Add</span></td>
		</tr>

		<tr>	<td align=center valign=bottom colspan=2 style="padding:15px; background-color: #f4deb7">
				<span class='guiButtonCancel' onclick='ASTGUI.hideDrag(event);'>Cancel</span>
				<span class='guiButtonEdit' onclick='save_FollowMeUser();'>Save</span>
			</td>
		</tr>
	</TABLE>
</div>

</body>
