<!--
 * Asterisk-GUI	- an Asterisk configuration interface
 *
 * Manage Service Providers trunks (Providers.conf)
 *
 * Copyright (C) 2008, Digium, Inc.
 *
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<script src="js/jquery.js"></script>
<script src="js/astman.js"></script>
<script src="js/jquery.tooltip.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<style type="text/css">

	#table_SPS_list {
		border: 0px solid #666666;
		margin-top: 8px;
		padding : 1px;
		width: 96%;
	}

	#table_SPS_list {
		border: 1px solid #666666;
		margin-top: 5px;
		margin-bottom:10px;
		width: 96%;
		text-align: center;
		padding : 1px;
	}
	#table_SPS_list tr.frow { background: #6b79a5; color: #CED7EF; }
	#table_SPS_list tr.frow td{ font-weight:bold; }
	#table_SPS_list tr td{ padding : 3px; }
	#table_SPS_list tr.even { background: #DFDFDF; }
	#table_SPS_list tr.odd{ background: #FFFFFF; }
	#table_SPS_list tr.even:hover, #table_SPS_list tr.odd:hover {
		background: #a8b6e5;
		cursor: default;
	}

</style>
<script>
var PROVIDERS = {};

var localajaxinit = function(){
	top.document.title = 'Service Providers' ;
	(function(){
		var t = [
			{url:'trunks_analog.html', desc:'Analog Trunks' } ,
			{url: '#', desc:'Service Providers', selected:true } ,
			{url:'trunks_voip.html', desc:'VOIP Trunks'}
		];
		if( !parent.sessionData.PLATFORM.isAA50 ){
			t.push({url:'trunks_digital.html', desc:'T1/E1/BRI Trunks'});
		}
		ASTGUI.tabbedOptions( _$('tabbedMenu') , t);
	})();

	(function(){
		PROVIDERS = config2json({ filename:'providers.conf', usf:1 });

		for (var this_provider in PROVIDERS ){ if(PROVIDERS.hasOwnProperty(this_provider) ){
			ASTGUI.selectbox.append('new_SP_Provider', PROVIDERS[this_provider].providername ||  this_provider , this_provider );
		}}
	})();

	$('#new_SP_Provider').click( function(){
		var selectedProvider = this.options[this.selectedIndex].value ;
		_$('TD_SP_desc').innerHTML = PROVIDERS[selectedProvider].providerdesc ;

		ASTGUI.domActions.removeAllChilds ('TD_SP_Logo_container');
		var logo_img  = document.createElement('IMG');
		$(logo_img).attr( 'src', PROVIDERS[selectedProvider].providerlogo );
		$(logo_img).attr('border', '0');
		_$('TD_SP_Logo_container').appendChild(logo_img) ;
	});

};




providers_MiscFunctions = {
	show_NewProviderForm : function(){ // providers_MiscFunctions.show_NewProviderForm();
		$('#new_SPTrunk_DIV').showWithBg();
	},

	createNewProvider : function(){ // providers_MiscFunctions.createNewProvider();
		if( _$('new_SP_Provider').selectedIndex == -1 ){
			alert('Please select a Provider');
			return;
		}

		var selectedProvider = _$('new_SP_Provider').value ;
		var trunk_template_obj = PROVIDERS[selectedProvider] ;
		var trunkname = trunk_template_obj.hasOwnProperty('trunk_username') ?  trunk_template_obj.trunk_username : ASTGUI.getFieldValue('input_sp_uname') ;
		if( !trunkname ){
			trunkname = parent.astgui_managetrunks.misc.nextAvailableTrunk_x() ;
		}
		var ct = ASTGUI.contexts.TrunkDIDPrefix + trunkname ;

		if(ASTGUI.getFieldValue('input_sp_uname')){
			trunk_template_obj.username = ASTGUI.getFieldValue('input_sp_uname') ;
		}
		if(ASTGUI.getFieldValue('input_sp_password')){
			trunk_template_obj.secret = ASTGUI.getFieldValue('input_sp_password') ;
		}
		trunk_template_obj.provider = trunk_template_obj.providername.guiMetaData();  ;
		trunk_template_obj.trunkname = trunk_template_obj.providername + trunkname.guiMetaData();

		var x = new listOfActions('users.conf');
		x.new_action('delcat', trunkname , '', '');
		x.new_action('newcat', trunkname , '', '');
		for( var d in trunk_template_obj ){
			if( !trunk_template_obj.hasOwnProperty(d) ){ continue; }
			x.new_action( 'append', trunkname , d, trunk_template_obj[d] );
		}

		var cb = function(){
			var v = new listOfSynActions('extensions.conf') ;
			v.new_action('delcat', ct, '', '');
			v.new_action('newcat', ct, '', ''); // add context
			v.new_action('delcat', ct + ASTGUI.contexts.TrunkDefaultSuffix , '', '');
			v.new_action('newcat', ct + ASTGUI.contexts.TrunkDefaultSuffix , '', ''); // add context
			v.new_action('append', ct , 'include', ct + ASTGUI.contexts.TrunkDefaultSuffix );

			if( trunk_template_obj.hasOwnProperty('hassip') && trunk_template_obj.hassip == 'yes'){
				 v.new_action('update', 'globals', trunkname , 'SIP/' + trunkname );
			}

			if( trunk_template_obj.hasOwnProperty('hasiax') && trunk_template_obj.hasiax == 'yes'){
				 v.new_action('update', 'globals', trunkname , 'IAX2/' + trunkname);
			}

			var h = v.callActions();
			if( h.contains('Response: Success') ){
				ASTGUI.dialog.waitWhile('Added New VOIP trunk<BR> Reloading GUI ... ');
				setTimeout( function(){ top.window.location.reload(); } , 2000 );
			}else{
				// something failed ??
			}
		};

		x.callActions(cb);
	}
};

</script>
<body bgcolor="EFEFEF">
<div class="iframeTitleBar">
	Manage Service Providers <span class='refresh_icon' onclick="window.location.reload();" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>

<div id="tabbedMenu"></div>

<div class='top_buttons' style="margin-top: -10px;">
	<span id='new_SP_button' class='guiButtonNew' onclick="providers_MiscFunctions.show_NewProviderForm();">New ServiceProvider</span>
</div>

<table id='table_SPS_list' cellpadding=0 cellspacing=0 border=0 align=center></table>

<div id="new_SPTrunk_DIV" STYLE="width:650; max-height:450;display:none;" class='dialog'>
	<TABLE width="100%" cellpadding=0 cellspacing=0>
	<TR class="dialog_title_tr">
		<TD class="dialog_title" onmousedown="ASTGUI.startDrag(event);">
			<span id='new_SP_DIV_Title'>Add New Service Provider</span>
		</TD>
		<TD class="dialog_title_X" onclick="ASTGUI.hideDrag(event);"> X </TD>
	</TR>
	</TABLE>

	<TABLE	align=center cellpadding=2 cellspacing=2 border=0 width='100%'>

	<TR>	<TD align="center" width='50%'>Choose a Service Provider &darr;</TD>
		<TD></TD>
	</TR>

	<TR>	<TD align="center">
			<select id='new_SP_Provider' style='width:250px' size=5></select>
		</TD>
		<TD id="TD_SP_Logo_container" align="center"></TD>
	</TR>

	<TR>	<TD align="center" id="TD_SP_desc" colspan=2></TD>
	</TR>
	<TR class='TR_SP_UP'>
		<TD align="right">Username:</TD>
		<TD align="left"><input size=12 id='input_sp_uname'></TD>
	</TR>
	<TR class='TR_SP_UP'>
		<TD align="right">Password:</TD>
		<TD align="left"><input size=12 id='input_sp_password'></TD>
	</TR>
	<TR>	<TD colspan=2 align=center height=50 valign=middle>
			<span class='guiButtonCancel' onclick='ASTGUI.hideDrag(event);'>Cancel</span>
			<span class='guiButtonEdit' id="new_SP_save" onclick='providers_MiscFunctions.createNewProvider();'>Add</span>
		</TD>
	</TR>
	</TABLE>
</div>

</body>
